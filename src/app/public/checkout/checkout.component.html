<div class="checkout-page" *ngIf="pedidoService.getTotalCajones() > 0; else sinPedido">

  <!-- HEADER / PASOS -->
  <section class="checkout-header">
    <h1>Confirmá tu pedido mayorista</h1>
    <p>Datos mínimos para coordinar entrega. Lo demás es opcional.</p>

    <div class="checkout-steps">
      <div class="step done">
        <div class="circle">
          <i class="material-icons step-icon">shopping_cart</i>
        </div>
        <span>Armar pedido</span>
      </div>

      <div class="step active">
        <div class="circle">
          <i class="material-icons step-icon">store</i>
        </div>
        <span>Entrega</span>
      </div>

      <div class="step">
        <div class="circle">
          <i class="material-icons step-icon">check_circle</i>
        </div>
        <span>Confirmación</span>
      </div>
    </div>
  </section>

  <!-- LAYOUT: FORM + RESUMEN -->
  <section class="checkout-layout">

    <!-- FORMULARIO -->
    <div class="card checkout-card checkout-form">
      <h2>Datos para la entrega</h2>
      <p class="subtitle">
        Con estos datos ya podemos coordinar. Si necesitás factura, activalo abajo.
      </p>

      <form novalidate>

        <!-- TELÉFONO (OBLIGATORIO) -->
        <div class="form-group">
          <label>Teléfono (WhatsApp)</label>

          <div class="telefono-row">
            <div class="input-with-icon flex-1">
              <i class="material-icons input-icon">phone</i>
              <input
                type="tel"
                class="form-control"
                name="telefono"
                [(ngModel)]="form.telefono"
                (blur)="onTelefonoBlur()"
                [readonly]="telefonoBloqueado"
                placeholder="Ej: 11 1234 5678" />
            </div>

            <button
              *ngIf="telefonoBloqueado"
              type="button"
              class="btn-link-edit"
              (click)="desbloquearTelefono()">
              Cambiar
            </button>
          </div>

          <div class="field-hint" *ngIf="telefonoBloqueado">
            Usamos este número para coordinar por WhatsApp
          </div>
        </div>


        <!-- DIRECCIÓN (OBLIGATORIO) -->
        <div class="form-group">
          <label>Dirección de entrega</label>
          <input
            type="text"
            class="form-control"
            name="direccion"
            [(ngModel)]="form.direccion"
            placeholder="Calle y número (piso/depto si aplica)" />
          <div class="field-error" *ngIf="formErrors.direccion">
            {{ formErrors.direccion }}
          </div>
        </div>

        <!-- LOCALIDAD (OBLIGATORIO) -->
        <div class="form-group">
          <label>Localidad / Barrio</label>
          <input
            type="text"
            class="form-control"
            name="localidad"
            [(ngModel)]="form.localidad"
            placeholder="Ej: Castelar / Morón / CABA" />
          <div class="field-error" *ngIf="formErrors.localidad">
            {{ formErrors.localidad }}
          </div>
        </div>

        <!-- BLOQUE OPCIONAL (COLAPSABLE SIMPLE) -->
        <div class="form-group" style="margin-top: 10px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <input
              type="checkbox"
              id="mostrarOpcionales"
              name="mostrarOpcionales"
              [(ngModel)]="form.mostrarOpcionales" />
            <label for="mostrarOpcionales" style="margin:0; cursor:pointer;">
              Agregar datos opcionales (comercio / horario / notas)
            </label>
          </div>
        </div>

        <div *ngIf="form.mostrarOpcionales">

          <!-- NOMBRE COMERCIO (OPCIONAL) -->
          <div class="form-group">
            <label>Nombre del comercio (opcional)</label>
            <div class="input-with-icon">
              <i class="material-icons input-icon">store</i>
              <input
                type="text"
                class="form-control"
                name="comercio"
                [(ngModel)]="form.comercio"
                placeholder="Ej: Verdulería San Juan" />
            </div>
            <div class="field-error" *ngIf="formErrors.comercio">
              {{ formErrors.comercio }}
            </div>
          </div>

          <!-- HORARIO (OPCIONAL - SIMPLE) -->
          <div class="form-group">
            <label>Horario preferido (opcional)</label>
            <div class="input-with-icon">
              <i class="material-icons input-icon">schedule</i>

              <select
                class="form-control"
                name="horario"
                [(ngModel)]="form.horario">
                <option value="">Lo antes posible</option>
                <option value="mañana">Mañana (9 a 12)</option>
                <option value="mediodia">Mediodía (12 a 15)</option>
                <option value="tarde">Tarde (15 a 18)</option>
              </select>

            </div>
          </div>


          <!-- NOTAS (OPCIONAL) -->
          <div class="form-group">
            <label>Notas (opcional)</label>
            <textarea
              class="form-control"
              name="notas"
              rows="3"
              [(ngModel)]="form.notas"
              placeholder="Referencia de entrega, contacto alternativo, etc."></textarea>
          </div>

        </div>

        <!-- FACTURA (TOGGLE) -->
        <div class="form-group" style="margin-top: 6px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <input
              type="checkbox"
              id="necesitaFactura"
              name="necesitaFactura"
              [(ngModel)]="form.necesitaFactura" />
            <label for="necesitaFactura" style="margin:0; cursor:pointer;">
              Necesito factura
            </label>
          </div>
        </div>

        <!-- CUIT SOLO SI PIDE FACTURA -->
        <div class="form-group" *ngIf="form.necesitaFactura">
          <label>CUIT</label>
          <input
            type="text"
            class="form-control"
            name="cuit"
            [(ngModel)]="form.cuit"
            placeholder="Ej: 20-12345678-9" />
          <div class="field-error" *ngIf="formErrors.cuit">
            {{ formErrors.cuit }}
          </div>
        </div>

        <!-- BOTÓN CONFIRMAR -->
        <button
          type="button"
          class="btn-confirmar"
          (click)="confirmarPedido()"
          [disabled]="items.length === 0">
          Confirmar pedido
        </button>

      </form>
    </div>

    <!-- RESUMEN -->
    <div class="card checkout-card checkout-summary">
      <h2>Resumen del pedido</h2>

      <div class="summary-list">
        <div class="summary-item" *ngFor="let item of items">
          <div class="summary-left">
            <div class="summary-name">
              <i class="material-icons summary-bullet">inventory_2</i>
              <span>{{ item.producto.nombre }}</span>
            </div>

            <div class="summary-detail">
              {{ item.cantidadCajones }} cajones ·
              {{ item.producto.kilosPorCajon * item.cantidadCajones }} kg
            </div>

            <!-- CONTROLES DE CANTIDAD -->
            <div class="summary-qty">
              <button type="button" (click)="restar(item)">
                <i class="material-icons">remove</i>
              </button>
              <span>{{ item.cantidadCajones }}</span>
              <button type="button" (click)="sumar(item)">
                <i class="material-icons">add</i>
              </button>
              <button type="button" class="summary-remove" (click)="eliminarItem(item)">
                <i class="material-icons">delete</i>
              </button>
            </div>
          </div>

          <div class="summary-price">
            {{ item.producto.precioPorCajon * item.cantidadCajones | currency:'ARS' }}
          </div>
        </div>

        <p *ngIf="items.length === 0" class="no-items">
          No hay productos en el pedido.
        </p>
      </div>

      <div class="summary-footer" [class.summary-footer--bounce]="animandoResumen">
        <div class="line">
          <span>Cajones totales</span>
          <span>{{ pedidoService.getTotalCajones() }}</span>
        </div>
        <div class="line total">
          <span>Total estimado</span>
          <span class="total-pill">
            {{ pedidoService.getTotalEstimado() | currency:'ARS' }}
          </span>
        </div>
      </div>

      <p class="summary-note">
        Una vez confirmado el pedido, nos contactamos para coordinar entrega y forma de pago.
      </p>

      <button type="button" class="btn-volver-catalogo" (click)="volverAlCatalogo()">
        Seguir editando el pedido
      </button>
    </div>

  </section>
</div>

<ng-template #sinPedido>
  <div class="checkout-empty">
    <h2>No tenés productos en el carrito.</h2>
    <p>Volvé al catálogo para armar tu pedido mayorista.</p>
    <button class="btn-volver" [routerLink]="['/']">Ir al catálogo</button>
  </div>
</ng-template>
